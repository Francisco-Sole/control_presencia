<script type="text/javascript" src="frameworks/jquery-3.2.1.min.js"></script>
<table  id="tablaCalendario" border="1px">
    <tr id="fila0" class="diasSemana">
        <th id=th0></th>
        <th id=th1></th>
        <th id=th2></th>
        <th id=th3></th>
        <th id=th4></th>
        <th id=th5></th>
        <th id=th6></th>
    </tr>
    <tr id="fila1">
        <td valign="top" id=td-1-1></td>
        <td valign="top" id=td-1-2></td>
        <td valign="top" id=td-1-3></td>
        <td valign="top" id=td-1-4></td>
        <td valign="top" id=td-1-5></td>
        <td valign="top" id=td-1-6></td>
        <td valign="top" id=td-1-0></td>
    </tr>
    <tr id="fila2">
        <td valign="top" id=td-2-1></td>
        <td valign="top" id=td-2-2></td>
        <td valign="top" id=td-2-3></td>
        <td valign="top" id=td-2-4></td>
        <td valign="top" id=td-2-5></td>
        <td valign="top" id=td-2-6></td>
        <td valign="top" id=td-2-0></td>
    </tr>
    <tr id="fila3"> 
        <td valign="top" id=td-3-1></td>
        <td valign="top" id=td-3-2></td>
        <td valign="top" id=td-3-3></td>
        <td valign="top" id=td-3-4></td>
        <td valign="top" id=td-3-5></td>
        <td valign="top" id=td-3-6></td>
        <td valign="top" id=td-3-0></td>
    </tr>
    <tr id="fila4">
        <td valign="top" id=td-4-1></td>
        <td valign="top" id=td-4-2></td>
        <td valign="top" id=td-4-3></td>
        <td valign="top" id=td-4-4></td>
        <td valign="top" id=td-4-5></td>
        <td valign="top" id=td-4-6></td>
        <td valign="top" id=td-4-0></td>
    </tr>
    <tr id="fila5">
        <td valign="top" id=td-5-1></td>
        <td valign="top" id=td-5-2></td>
        <td valign="top" id=td-5-3></td>
        <td valign="top" id=td-5-4></td>
        <td valign="top" id=td-5-5></td>
        <td valign="top" id=td-5-6></td>
        <td valign="top" id=td-5-0></td>
    </tr>
    <tr id="fila6">
        <td valign="top" id=td-6-1></td>
        <td valign="top" id=td-6-2></td>
        <td valign="top" id=td-6-3></td>
        <td valign="top" id=td-6-4></td>
        <td valign="top" id=td-6-5></td>
        <td valign="top" id=td-6-6></td>
        <td valign="top" id=td-6-0></td>
    </tr>
</table>


<script type="text/javascript">
    /*
    DEFINIMOS CONSTANTES
    */
//fecha
var __fecha = new Date();
//dias de la semana
var __diasDeLaSemana = ["Domingo","Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado"];
//meses
var __meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];

//datos de hoy
var __diaHoy = __fecha.getDate();
var __mesHoy = __fecha.getMonth()+1;
var __mesDelAnyo = __meses[__fecha.getMonth()]
var __anyoHoy = __fecha.getFullYear();
var __diaSemanaHoy = __diasDeLaSemana[__fecha.getDay()];

//datos del dia 1 de ese mes.
var __datosDia1 = new Date(__fecha.getTime() - ((24 * 60 * 60 * 1000) * (__diaHoy - 1)));
//obtenemos info del dia 1.
var __diaSemanaDia1 = __datosDia1.getDay();

// fin constantes


/*
    VARIABLES GLOBALES
    */
    var __arrayDiasDelMes = new Array();
    var reservasDelMes = new Array();
    var __arrayDiasSeleccionados = new Array();
    var nombreUser;
    var color;
    var miId;
    var DELAY = 400;
    var clicks = 0; 
    var timer = null;


//fin variables locales.
pintaCalendario()

$("#anyoVisible").val(__anyoHoy);

//asigno valor al select.
$("#selectMesTexto").val(__mesHoy-1);

//comportamiento change del select.
$("#selectMesTexto").change(function(event) {
    var mes = $(this).val();
    __datosDia1.setMonth(mes);
    __datosDia1.setFullYear($("#anyoVisible").val());
    pintaCalendario('limpia');
    cargaReservas();
});



//comportamiento change del input fecha.
$("#anyoVisible").change(function(event) {
    var anyo = $(this).val();
    __datosDia1.setFullYear(anyo);
    __datosDia1.setMonth($("#selectMesTexto").val());
    pintaCalendario('limpia');
    cargaReservas();
});

/*
    Pinta el calendario, puedes pasar parametro para limpiar el calendario.
    */
    function pintaCalendario(parametro){

        if (parametro == 'limpia') {
            $("#tablaCalendario tr td").each(function(index, el) {
                $(this).empty()
                .removeAttr('dia')
                .removeAttr('mes')
                .removeAttr('anyo')
                .removeAttr('diaTexto')
                .removeAttr('mesTexto')
                .removeAttr('diaTextoNum');
            });
        }

        //printamos las cabezeras del calendario
        $("#tablaCalendario tr th").each(function(index, el) 
        {
            //si el dia es domingo, pintalo el ultimo no el primero
            if (index == 6) 
            {
                $(this).html(__diasDeLaSemana[0]).css({
                    "width": 'calc( 97vw / 7 )'
                }); 
            }
            else
            {
                $(this).html(__diasDeLaSemana[index+1]).css({
                    "width": 'calc( 97vw / 7 )'
                }); 
            }
        });

        //hacemos un array con los dias del mes.
        var dia=1;
        var i=0;
        __arrayDiasDelMes = new Array();
        while(dia <= __datosDia1.getDate()){
            __arrayDiasDelMes[i] = {};
            __arrayDiasDelMes[i]['dia'] = __datosDia1.getDate();
            __arrayDiasDelMes[i]['mes'] = __datosDia1.getMonth();
            __arrayDiasDelMes[i]['anyo'] = __datosDia1.getFullYear();
            __arrayDiasDelMes[i]['diaTexto'] = __diasDeLaSemana[__datosDia1.getDay()];
            __arrayDiasDelMes[i]['mesTexto'] = __meses[__datosDia1.getMonth()];
            __arrayDiasDelMes[i]['diaTextoNum'] = __datosDia1.getDay();
            i++;
            dia++;
            __datosDia1.setDate(dia);
        }

        //empezamos en semana 1
        var sem=1;
        var izq;
        //bloque pinto dias del mes.
        //recorro el array, y busco por dia y dia de la semana, si el dia de la semana llega a domingo sumo 1 a la semana actual.
        for (var i = 0; i < __arrayDiasDelMes.length; i++) {
            //si el dia 1 es lunes, emepezamos en semana 2.
            if (i==0 && __arrayDiasDelMes[0]['diaTextoNum'] == 1) {
                sem = 2;
            }
            id = "td-"+sem+"-"+__arrayDiasDelMes[i]['diaTextoNum'];
            //si solo es de un digito lo centro.
            if (__arrayDiasDelMes[i]['dia'].toString().length == 1) {
                izq= "8.5";
            }
            else{
                izq = "3.5";
            }
            var color = "transparent";
            //si el dia del array coincide con hoy lo pinto.
            if (__arrayDiasDelMes[i]['dia'] == __diaHoy && (__arrayDiasDelMes[i]['mes']+1)== __mesHoy && __arrayDiasDelMes[i]['anyo'] == __anyoHoy) {
                color = "#00C0F3";
            }
            else{
                color = "transparent";
            }
            //genero el dia, un circulo y le asigno unos atributos.
            $("#"+id).html("<div id='redondo"+__arrayDiasDelMes[i]['dia']+"' class='redondo' style='height:25px; width:25px; border-radius:50%; background-color: "+color+"'></div><span style='position:relative;top:-24px;left:"+izq+"px'>"+__arrayDiasDelMes[i]['dia']+"</span>").attr({
                dia: __arrayDiasDelMes[i]['dia'] ,
                mes: __arrayDiasDelMes[i]['mes'] ,
                anyo: __arrayDiasDelMes[i]['anyo'] ,
                diaTexto: __arrayDiasDelMes[i]['diaTexto'] ,
                mesTexto: __arrayDiasDelMes[i]['mesTexto'] , 
                diaTextoNum: __arrayDiasDelMes[i]['diaTextoNum'],
                activo: "0"
            }).bind({
                click: function(){
                    marcarDiaCalendario(this);
                }
            });
            //si llego a domingo , cambio de semana.
            if (__arrayDiasDelMes[i]['diaTextoNum'] == 0){
                sem++;
            }
        }
    };    

    function marcarDiaCalendario(elemento){
        var activo = $(elemento).attr("activo");
        if (activo == "0") {
            //marco
            $(elemento).css({
                "background-color": "darkturquoise"
            }).attr("activo", "1");
            agregarDia(parseInt($(elemento).attr("dia")),parseInt($(elemento).attr("mes"))+1, parseInt($(elemento).attr("anyo")));
        }
        else{
            //desmarco
            $(elemento).css({
                "background-color": "transparent"
            }).attr("activo", "0");
            borrarDia(parseInt($(elemento).attr("dia")),parseInt($(elemento).attr("mes"))+1, parseInt($(elemento).attr("anyo")));

        }
    }

    function resetArrayDiasSeleccionados(){
        __arrayDiasSeleccionados = new Array();
    }

    function agregarDia(dia, mes, anyo){
        var temp = {"dia": dia, "mes": mes, "anyo": anyo};
        __arrayDiasSeleccionados.push(temp);
        console.log(__arrayDiasSeleccionados);
    }

    function borrarDia(dia, mes, anyo){
        for (var i = 0; i < __arrayDiasSeleccionados.length; i++) {
            if(__arrayDiasSeleccionados[i].dia == dia && __arrayDiasSeleccionados[i].mes == mes && __arrayDiasSeleccionados[i].anyo == anyo){
                __arrayDiasSeleccionados.splice(i,1);
            }
        }
        console.log(__arrayDiasSeleccionados);
    }
</script>
